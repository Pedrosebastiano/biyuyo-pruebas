name: Actualizar Tasa BCV Diariamente

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 00:01 hora de Venezuela (UTC-4)
    # Venezuela UTC-4 â†’ 00:01 VET = 04:01 UTC
    - cron: '1 4 * * *'
  workflow_dispatch: # Permite ejecutarlo manualmente desde GitHub

jobs:
  update-rates:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Permiso vital para poder guardar el JSON en el repo

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Obtener todo el historial para evitar conflictos

      - name: ğŸŸ¢ Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      - name: ğŸ•·ï¸ Ejecutar Scraper BCV
        run: npm run scraper
        env:
          TZ: America/Caracas # Establecer zona horaria de Venezuela

      - name: ğŸ’¾ Configurar Git
        run: |
          git config --global user.name "BCV Bot"
          git config --global user.email "bot@noreply.github.com"

      - name: ğŸ“¤ Guardar cambios (Commit & Push)
        run: |
          # Verificar si hubo cambios en el archivo
          if git diff --quiet public/rates.json; then
            echo "âœ… No hay cambios en la tasa hoy (misma tasa que ayer)"
          else
            git add public/rates.json
            git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica: Tasa BCV $(date +'%d/%m/%Y')"
            git pull --rebase origin main || git pull --rebase origin master
            git push
            echo "âœ… Tasa actualizada y guardada en el repositorio"
          fi

      - name: ğŸ“Š NotificaciÃ³n de resultado
        if: success()
        run: echo "âœ… Workflow completado exitosamente a las $(date)"

      - name: âŒ NotificaciÃ³n de error
        if: failure()
        run: |
          echo "âŒ FallÃ³ el scraper BCV. Revisa los logs."
          exit 1
